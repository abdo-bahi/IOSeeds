{% extends "layouts/base.html" %} {% block title %}{% endblock %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}
<link rel="stylesheet" type="text/css" href="/static/evo-calendar.min.css"/>
<div class="pcoded-content">
  {% csrf_token %}
  {% load static %}
  <!-- {{ mcu|json_script:"mcu" }}
<script>
  const mcu = JSON.parse(document.getElementById('mcu').textContent);
</script> -->
  <div class="pcoded-inner-content">
    <!-- [ breadcrumb ] start -->
    <!-- [ breadcrumb ] end -->
    <div class="main-body">
      <div class="page-wrapper">
        <!-- [ Main Content ] start -->       
        <a  id="mobile-collapse" href="javascript:"><span ><img width="40px"  src="{% static 'images/menu.png' %}"></span></a>

        {% if not mcuId %}
                <h2 class="mb-4" style="color: gray;">Welcome, please login and setup your ESP !</h2><br/>
             
              {%else%}
              <h3 id="irrigationField">Irrigation field : </h3> 
              <h4 id="lastUpdated">Last Update : </h4> 
              {% endif %}
        <div class="row"> 
              
          <!--[ daily sales section ] start-->
          <div class="col-md-6 col-xl-4">
            <div class="card daily-sales">
             
              <div class="card-block">
                <h6 class="mb-4">Temperature</h6>
                <div class="row d-flex align-items-center">
                  <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0" id="temperature">
                      <!-- {{result.Temperature.Data}} -->
                    </h3>
                  </div>

                  <div class="col-3 text-right" style="right: 20%;">
                    <img width="80px"  src="{% static 'images/temperature.png' %}">
                  </div>
                </div>
                <div class="progress m-t-30" style="height: 7px">
                  <div
                    class="progress-bar progress-c-theme2"
                    role="progressbar"
                    style="width: 100%"
                    aria-valuenow="35"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 col-xl-4">
            <div class="card Monthly-sales">
              <div class="card-block">
                <h6 class="mb-4">Humidity</h6>
                <div class="row d-flex align-items-center">
                  <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0" id="humidity">
                      <!-- {{result.Humidity.Data}} -->
                    </h3>
                  </div>
                  <div class="col-3 text-right" style="right: 20%;">
                    <img width="70px"  src="{% static 'images/humidity.png' %}">
                  </div>
                </div>
                <div class="progress m-t-30" style="height: 7px">
                  <div
                    class="progress-bar progress-c-theme"
                    role="progressbar"
                    style="width: 100%"
                    aria-valuenow="70"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>
          <!--[ Monthly  sales section ] end-->
          <!--[ year  sales section ] starts-->
          <div class="col-md-12 col-xl-4">
            <div class="card yearly-sales">
              <div class="card-block">
                <h6 class="mb-4">Soil Moisture</h6>
                <div class="row d-flex align-items-center">
                  <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0" id="soilMoisture">
                      <!-- {{result.WaterTemp.Data}} -->
                    </h3>
                  </div>
                  <div class="col-3 text-right" style="right: 20%;">
                    <img width="70px"  src="{% static 'images/tempeau.png' %}">
                  </div>
                </div>
                <div class="progress m-t-30" style="height: 7px">
                  <div
                    class="progress-bar progress-c-theme2"
                    role="progressbar"
                    style="width: 100%"
                    aria-valuenow="35"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-12 col-xl-4">
            <div class="card yearly-sales">
              <div class="card-block">
                <h6 class="mb-4">Water Pump</h6>
                <div class="row d-flex align-items-center">
                  <div class="col-9">
                    <h3 class="f-w-300 d-flex align-items-center m-b-0" id="waterPumpVal">
                      <!-- {{result.pH.Data}} -->
                    </h3>
                  </div>
                  <div class="col-3 text-right" style="right: 15%;">
                    <img width="70px" height="70px" src="{% static 'images/pump.png' %}">
                  </div>
                </div>
                <div class="progress m-t-30" style="height: 7px">
                  <div 
                    class="progress-bar progress-c-theme"
                    role="progressbar"
                    style="width: 100%"
                    aria-valuenow="70"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-12 col-xl-4">
            <div class="card yearly-sales">
              <div class="card-block">
                <h6 class="mb-4">Start Irrigation</h6>
                <div class="row d-flex align-items-center">
                  <div class="col-9">
                    <button class="btn btn-primary" id="irrigationBtn">
                      <!-- {{result.pH.Data}} -->Irrigation
                    </button>
                  </div>
                  <div class="col-3 text-right" style="right: 15%;">
                    <img width="70px" height="70px" src="{% static 'images/irrigate.png' %}">
                  </div>
                </div>
                <div class="progress m-t-30" style="height: 7px">
                  <div 
                    class="progress-bar progress-c-theme"
                    role="progressbar"
                    style="width: 100%"
                    aria-valuenow="70"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
  <script>
    const buttons = document.getElementsByClassName('fixed-button');

// Loop through all the elements and hide them
for (let i = 0; i < buttons.length; i++) {
  buttons[i].style.display = 'none';
}
    let notificationPerm ;
    let irrigationNotificationTimer;
    let drySoilNotificationTimer;
    if ('Notification' in window) {
      Notification.requestPermission().then(perm => {
      if(perm === "granted"){
        notificationPerm = true;
      } })
    }
    else{
        notificationPerm = false;
      }
   
    var alertIrrigation = `Are you sure you want to start irrigation for 10 seconds or till 30% Moisture`;
    const mcuId = '{{ mcuId }}';
        const SSE_URL = `/sensor-data-stream/${mcuId}/`;
        let eventSource;
const soilMoistureElement = document.getElementById('soilMoisture');
const temperatureElement = document.getElementById('temperature');
const humidityElement = document.getElementById('humidity');
const waterPumpValElement = document.getElementById('waterPumpVal');
const irrigationFieldElement = document.getElementById('irrigationField');
const lastUpdatedElement = document.getElementById('lastUpdated');
const irrigationBtn = document.getElementById('irrigationBtn');

// const url = `/api/mcu/${mcuId}/`;  // Adjust URL based on your API endpoint
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const url = `/api/mcu/${mcuId}/`;  // Adjust URL based on your API endpoint

function updateData(data) {
  temperatureElement.textContent = (data.temperature != undefined)? `${data.temperature} Â°C` : '';
  
  humidityElement.textContent = (data.humidity != undefined)? `${data.humidity} %` : '';
  irrigationFieldElement.textContent = (data.name != undefined)? `Irrigation field : ${data.name}` : 'Irrigation field : ';
  lastUpdatedElement.textContent = (data.dateTime != undefined)? `Last Update : ${data.dateTime.yyyy}/${data.dateTime.mm}/${data.dateTime.dd} at ${data.dateTime.h}:${data.dateTime.m}:${data.dateTime.s}` : 'Last Update : ';
  soilMoistureElement.textContent = (data.soilMoisture != undefined)? `${data.soilMoisture} %` : '';
  if (data.waterPumpVal) {
    waterPumpValElement.textContent = 'ON';
  } 
  else if(data.temperature != undefined) {
    waterPumpValElement.textContent = 'OFF';
  }
  alertIrrigation = (data.soilMoisture == undefined)?`Are you sure you want to start irrigation for 30 seconds or till 30% Moisture` : 
  `Are you sure you want to start irrigation for ${data.irrigationTime} seconds or till ${data.threshold} % Moisture`  ;
  if ( (data.soilMoisture != undefined) && (data.threshold != undefined) && (data.soilMoisture <= data.threshold)) {
    if (notificationPerm) {
    var notification = new Notification('Dry soil !', {
        body: `Soil Moisture is currently : ${data.soilMoisture} %`,
        // icon : '/static/assets/images/IOS.png',
        tag : 'drySoil',
    });
    clearTimeout(drySoilNotificationTimer);
    }
    else{
      Notification.requestPermission().then(perm => {
      if(perm === "granted"){
        notificationPerm = true;
        var notification = new Notification('Irrigation Started !', {
        body: `Irrigation Started !`,
        // icon : '/static/assets/images/IOS.png',
        tag : 'irrigation',
    });
      } })
    }
  //   drySoilNotificationTimer = setTimeout(() => {
  //     drySoilNotificationTimer = null; // Reset timer after delay
  // }, 10000 );
  }
  
}
window.onload = function() {  // Run code on page load
  if (mcuId) {
      eventSource = new EventSource(SSE_URL);
  eventSource.onmessage = event => {
    const data = JSON.parse(event.data);
    updateData(data);
  };
  
  eventSource.onerror = function(error) {
    console.error("Error:", error);
  };
  }
};

 irrigationBtn.addEventListener('click', () => {
      var result = confirm(alertIrrigation);
      if (result) {
        const waterPumpVal = true;

      const request = new XMLHttpRequest();

      request.open('PUT', url);
      request.setRequestHeader('Content-Type', 'application/json');
      request.setRequestHeader('X-CSRFToken', csrftoken);

      const data = JSON.stringify({ "waterPumpVal" : waterPumpVal});

      request.onload = function () {
  if (request.status === 200) {
    console.log('Success:', request.responseText); 
    alert('irrigation started !');
  } else {
    console.error('Error:', request.statusText);
  }
};

request.onerror = function () {
  console.error('Network error:', request.statusText);
};

      request.send(data);
       
    if ( notificationPerm) {
    var notification = new Notification('Irrigation Started !', {
        body: `Irrigation Started !`,
        // icon : '/static/assets/images/IOS.png',
        tag : 'irrigation',
    });
  //   clearTimeout(irrigationNotificationTimer);
  //   irrigationNotificationTimer = setTimeout(() => {
  //     irrigationNotificationTimer = null; // Reset timer after delay
  // }, 10000);
    }
    else{Notification.requestPermission().then(perm => {
      if(perm === "granted"){
        notificationPerm = true;
        var notification = new Notification('Irrigation Started !', {
        body: `Irrigation Started !`,
        // icon : '/static/assets/images/IOS.png',
        tag : 'irrigation',
    });
      } })}
    
  
  } else {
        alert('irrigation canceled !')
      }
 });
  </script>
{% endblock javascripts %}
